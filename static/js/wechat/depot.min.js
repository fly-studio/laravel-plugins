/*! depot.js 2016-10-28 18:05:51*/
var $app=angular.module("app");$app.requires=["jquery","ui.bootstrap","utils","ngInputModified","ng.ueditor"],$app.config(["inputModifiedConfigProvider",function(e){e.disableGlobally()}]).controller("depotSelector",["$rootScope","$scope","$query","$uibModal","$log","$element",function(e,t,o,n,i,r){t.mode="preview",t.depotConfirmed={},t.depotSelected={},t.toSelect=function(){t.depotSelected=angular.copy(t.depotConfirmed)||{};var e=n.open({animation:!0,templateUrl:"wechat/depot/selector-modal",controller:"depotSelectorModal",size:"lg",backdrop:"static",scope:t});r.closest(".modal").hide(),e.result.then(function(){count(t.depotSelected)>=1&&(t.depotConfirmed=angular.copy(t.depotSelected)),r.closest(".modal").show()},function(){r.closest(".modal").show()})},t.unpreview=function(e){if("undefined"==typeof e)for(var o in t.depotConfirmed)delete t.depotConfirmed[o];else delete t.depotConfirmed[e]}}]).controller("depotSelectorModal",["$scope","$query","$uibModalInstance",function(e,t,o){}]).directive("depotSelector",["$query",function(e){return{restrict:"A",controller:"depotSelector",replace:!0,scope:{host:"@depotSelector",selectedLimit:"@selectedLimit"},require:"?ngModel",templateUrl:function(e,t){return t.templateUrl||"wechat/depot/selector"},link:function(t,o,n,i){var r=function(o){o&&0!=o&&e.post(jQuery.baseuri+"admin/wechat/depot/data/json",{filters:{id:{in:o}}},function(e){if("success"==e.result){for(var o={},n=0;n<e.data.data.length;n++){var i=e.data.data[n];o[i.id]=i}t.depotSelected=angular.copy(o),t.depotConfirmed=angular.copy(t.depotSelected),t.$apply()}},!1)};if(i)i.$render=function(){var e=i.$modelValue,t=e?e instanceof Array?e:e.toString().split(","):[];r(t)};else{var d=jQuery(t.host),a=d.val(),l=a?a instanceof Array?a:a.toString().split(","):[];r(l)}t.$watch("depotConfirmed",function(e,o){if(e!==o){var n=array_keys(t.depotConfirmed);if(t.host){var r=jQuery(t.host);r.is("select")&&(r.val([]).empty(),angular.forEach(n,function(e){jQuery('<option value="'+e.toString()+'">'+e.toString()+"</option>").appendTo(r)})),r.val(n)}i&&i.$setViewValue(n)}},!0)}}}]).controller("depotController",["$rootScope","$scope","$query","$uibModal","$log","$element",function(e,t,o,n,i,r){t.dataList={},t.types={news:{title:"\u56fe\u6587"},text:{title:"\u6587\u672c"},image:{title:"\u56fe\u7247"},callback:{title:"\u7f16\u7a0b"},video:{title:"\u89c6\u9891"},voice:{title:"\u5f55\u97f3"},music:{title:"\u97f3\u4e50"}},t.types[t.type].active=!0,t.depotSelected=t.$parent.depotSelected||{},t.load=function(e,n,i,r){i||(i={}),i.type=e,t.type=e,o.post(jQuery.baseuri+"admin/wechat/depot/data/json",{page:n,filters:i,orders:r},function(o){"success"==o.result?t.dataList[e]=o.data:jQuery.showtips(o)},!1)},t.reload=function(e){t.load(e,t.dataList[e].current_page,t.dataList[e].filters,t.dataList[e].orders)},t.select=function(e){if(t.selectedLimit<=1)t.unselect();else if(count(t.depotSelected)>=t.selectedLimit)return jQuery.alert("\u6700\u591a\u53ea\u80fd\u9009\u62e9"+t.selectedLimit+"\u9879\uff0c(\u8bf7\u67e5\u770b\u5176\u5b83\u5206\u7c7b\u662f\u5426\u88ab\u9009\u4e2d)",!0),!1;t.depotSelected[e.id]=e},t.unselect=function(e){if("undefined"==typeof e)for(var o in t.depotSelected)delete t.depotSelected[o];else delete t.depotSelected[e.id]},t.show=function(e,o){t.type=e,t[e]&&!o||t.load(e,1),t.types[e].active=!0},t.create=function(e){t.edit(e)},t.edit=function(o,i){$newScope=e.$new(!0,t),$newScope.type=o,$newScope.depotId=i;var r=n.open({animation:!0,templateUrl:"wechat/depot/edit",controller:"depotEditController",size:"lg",backdrop:"static",scope:$newScope,resolve:{}});r.result.then(function(){},function(){})},t.destroy=function(e,o){t.reload(e)},angular.forEach(t.types,function(e,o){t.$watch("dataList."+o+".current_page",function(e,n){e!==n&&(isNaN(n)||t.reload(o))})})}]).directive("depotController",function(){return{restrict:"A",scope:{mode:"@mode",type:"@depotController",selectedLimit:"@"},controller:"depotController",replace:!0,templateUrl:function(e,t){return t.templateUrl||"wechat/depot/controller"},link:function(e,t,o){e.selectedLimit||(e.selectedLimit=1)}}}).controller("depotListController",["$scope",function(e){}]).directive("depotList",function(){return{restrict:"A",scope:!1,require:["^depotController"],controller:"depotListController",replace:!0,templateUrl:function(e,t){return t.templateUrl||"wechat/depot/list"},link:function(e){}}}).directive("depotItem",["$compile","$templateRequest","$sce",function(e,t,o){return{restrict:"A",scope:!1,transclude:!0,require:["^depotList"],replace:!0,link:function(e,t,o){}}}]).controller("depotListOptionsController",["$scope",function(e){}]).directive("depotListOptions",function(){return{restrict:"A",scope:!1,controller:"depotListOptionsController",replace:!0,templateUrl:function(e,t){return t.templateUrl||"wechat/depot/list/options"},link:function(e){}}}).controller("depotEditController",["$scope","$uibModalInstance","$query",function(e,t,o){e.forms={},e.submiting=!1,e.ueditor_config=jQuery.ueditor_default_setting.simple,e.init=function(){e.depot={id:0,type:e.type},e.depot[e.type]=null},e.load=function(t,n){return o.post(jQuery.baseuri+"admin/wechat/depot/data/json",{pagesize:2,"filters[type]":e.type,"filters[id]":e.depotId},function(t){"success"==t.result?t.data&&t.data.data&&t.data.data[0]?e.depot=t.data.data[0]:e.init():jQuery.showtips(t)},!1)},e.createNews=function(){return e.depot.news&&e.depot.news instanceof Array||(e.depot.news=[]),e.depot.news.length>=8?(jQuery.alert("\u6700\u591a\u53ea\u80fd\u521b\u5efa8\u6761\u56fe\u6587\uff01",!0),!1):(e.depot.news.push({id:"",title:"",cover_id:"",cover_in_content:!0,description:"",redirect:!0,content:"",url:""}),void e.editNews(e.depot.news.length-1))},e.editNews=function(t){angular.forEach(e.depot.news,function(e){e.active=!1}),e.depot.news[t].active=!0},e.saveNews=function(){if(!e.forms.news)return!1;var t=[];return angular.forEach(e.forms.news,function(n,i){var r=jQuery('[name="'+n.$name+'"]');t.push(o.form(r,function(t){t.data&&(e.depot.news[i].id=t.data.id,n.$setPristine(),e.$apply())},!1).fail(function(t){e.editNews(i),jQuery.showtips(t)}).done(function(e){}))}),jQuery.when.apply(this,t)},e.destroyNews=function(t){return!(e.depot.news.length<=1)&&void(e.forms.news[t].modified?jQuery.confirm("\u60a8\u5df2\u4fee\u6539\u672c\u6587\u7ae0\uff0c\u662f\u5426\u786e\u5b9a\u5220\u9664\uff1f",function(){e.depot.news.splice(t,1),e.editNews(t<=0?0:t-1),e.$apply()}):(e.depot.news.splice(t,1),e.editNews(t<=0?0:t-1)))},e.prevNews=function(t){if(t<=0)return!1;var o=angular.copy(e.depot.news[t]),n=angular.copy(e.depot.news[t-1]);e.depot.news[t]=n,e.depot.news[t-1]=o,e.editNews(t-1)},e.nextNews=function(t){if(t>=e.depot.news.length-1)return!1;var o=angular.copy(e.depot.news[t]),n=angular.copy(e.depot.news[t+1]);e.depot.news[t]=n,e.depot.news[t+1]=o,e.editNews(t+1)},e.cancel=function(){var o=!1;for(var n in e.form)e.form[n].modified&&(o=!0);o?jQuery.confirm("\u5185\u5bb9\u5df2\u4fee\u6539\uff0c\u60a8\u786e\u5b9a\u4e0d\u4fdd\u5b58\uff1f",function(){t.dismiss("cancel")}):t.dismiss("cancel")},e.save=function(){e.submiting=!0;var n=function(){o.form(jQuery('[name="forms.depot"]')).done(function(o){e.depot=o.data,t.close(),o.data.isCreated?e.$parent.$parent.show(o.data.type):e.$parent.$parent.reload(o.data.type)}).always(function(){e.submiting=!1})};"news"==e.type?e.saveNews().done(n).fail(function(){e.submiting=!1}):n()},e.$on("uploader.uploaded",function(t,o,n,i,r,d){"news"!=e.type&&n.is('[name="aid"]')&&(e.depot[e.type].title=r.data.filename,e.depot[e.type].size=r.data.size,e.depot[e.type].format=r.data.ext,e.$apply())}),e.$on("uploader.removed",function(t,o,n,i,r,d){"news"!=e.type&&n.is('[name="aid"]')&&(e.depot[e.type].title="",e.depot[e.type].size=0,e.depot[e.type].format="",e.$apply())}),!isNaN(e.depotId)&&e.depotId>0?e.load().done(function(){"news"==e.type&&e.editNews(0)}):(e.init(),"news"==e.type&&e.createNews())}]);